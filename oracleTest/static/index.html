<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게시판</title>
    <style>
        :root {
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --primary-light: #dbeafe;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --danger: #ef4444;
            --danger-hover: #dc2626;
            --success: #22c55e;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        @media (min-width: 640px) {
            .container { padding: 2rem; }
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 1.5rem 0;
        }

        h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .subtitle { color: var(--text-secondary); font-size: 0.875rem; }

        .form-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.25rem;
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
        }

        @media (min-width: 640px) {
            .form-card { padding: 1.5rem; }
        }

        .form-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group { margin-bottom: 1rem; }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text);
            font-size: 0.875rem;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 0.9375rem;
            font-family: inherit;
            transition: all 0.2s ease;
            background: var(--bg);
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
            background: var(--card-bg);
        }

        .form-group textarea { min-height: 100px; resize: vertical; }

        .btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 10px;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover:not(:disabled) { background: var(--primary-hover); transform: translateY(-1px); box-shadow: var(--shadow-md); }

        .btn-danger { background: var(--danger); color: white; padding: 0.5rem 0.875rem; font-size: 0.8125rem; }
        .btn-danger:hover:not(:disabled) { background: var(--danger-hover); }

        .btn-secondary { background: var(--bg); color: var(--text); border: 1px solid var(--border); }
        .btn-secondary:hover:not(:disabled) { background: var(--border); }

        .btn-edit { background: var(--text-secondary); color: white; padding: 0.5rem 0.875rem; font-size: 0.8125rem; margin-right: 0.375rem; }
        .btn-edit:hover:not(:disabled) { background: #475569; }

        .form-actions { display: flex; gap: 0.75rem; justify-content: flex-end; }

        .boards-list { display: flex; flex-direction: column; gap: 1rem; }

        .load-more { text-align: center; margin-top: 1.5rem; }
        .load-more .btn { min-width: 180px; }

        .board-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.25rem;
            box-shadow: var(--shadow);
            transition: all 0.25s ease;
            border: 1px solid var(--border);
            animation: fadeIn 0.3s ease;
        }

        @media (min-width: 640px) { .board-card { padding: 1.5rem; } }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .board-card:hover { box-shadow: var(--shadow-lg); transform: translateY(-2px); border-color: var(--primary-light); }

        .board-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
            gap: 0.75rem;
        }

        .board-title { font-size: 1.0625rem; font-weight: 600; color: var(--text); line-height: 1.4; flex: 1; }

        .board-actions { display: flex; gap: 0.375rem; flex-shrink: 0; }

        .board-content { color: var(--text-secondary); white-space: pre-wrap; font-size: 0.9375rem; line-height: 1.7; }

        .board-meta {
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
            font-size: 0.8125rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1.5rem;
            color: var(--text-secondary);
            background: var(--card-bg);
            border-radius: 16px;
            border: 1px dashed var(--border);
        }

        .empty-state svg { width: 48px; height: 48px; margin-bottom: 1rem; opacity: 0.5; }

        .loading { text-align: center; padding: 3rem 1.5rem; color: var(--text-secondary); }

        .spinner {
            width: 36px;
            height: 36px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: var(--danger);
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            font-size: 0.9375rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .hidden { display: none !important; }

        #editForm { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border); animation: slideDown 0.3s ease; }

        .toast-container { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 1000; display: flex; flex-direction: column; gap: 0.75rem; }

        .toast {
            padding: 1rem 1.25rem;
            border-radius: 12px;
            font-size: 0.9375rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideInRight 0.3s ease;
            box-shadow: var(--shadow-lg);
            max-width: 320px;
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }

        .toast-success { background: #f0fdf4; border: 1px solid #bbf7d0; color: #166534; }
        .toast-error { background: #fef2f2; border: 1px solid #fecaca; color: #991b1b; }

        .toast-icon { width: 20px; height: 20px; flex-shrink: 0; }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            padding: 1rem;
            animation: fadeIn 0.2s ease;
        }

        .modal {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            max-width: 400px;
            width: 100%;
            box-shadow: var(--shadow-lg);
            animation: scaleIn 0.2s ease;
        }

        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-title { font-size: 1.125rem; font-weight: 600; margin-bottom: 0.75rem; }
        .modal-content { color: var(--text-secondary); margin-bottom: 1.5rem; font-size: 0.9375rem; }
        .modal-actions { display: flex; gap: 0.75rem; justify-content: flex-end; }

        .btn-loading { position: relative; color: transparent !important; }
        .btn-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border: 2px solid white;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                </svg>
                게시판
            </h1>
            <p class="subtitle">CRUD operations with Axum + Oracle</p>
        </header>

        <div id="errorMessage" class="error hidden">
            <svg class="toast-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="15" y1="9" x2="9" y2="15"></line>
                <line x1="9" y1="9" x2="15" y2="15"></line>
            </svg>
            <span id="errorText"></span>
        </div>

        <div class="form-card">
            <h2 class="form-title">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                새 글 작성
            </h2>
            <form id="createForm">
                <div class="form-group">
                    <label for="title">제목</label>
                    <input type="text" id="title" name="title" required placeholder="제목을 입력하세요..." maxlength="200">
                </div>
                <div class="form-group">
                    <label for="content">내용</label>
                    <textarea id="content" name="content" required placeholder="내용을 입력하세요..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                        작성
                    </button>
                </div>
            </form>
        </div>

        <div class="boards-list" id="boardsList">
            <div class="loading"><div class="spinner"></div><p>게시글을 불러오는 중...</p></div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script>
        const API_BASE = '/boards';
        const DEFAULT_SIZE = 10;

        let cursor = null;
        let hasMore = false;
        let isLoading = false;

        const createForm = document.getElementById('createForm');
        const boardsList = document.getElementById('boardsList');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const toastContainer = document.getElementById('toastContainer');
        const submitBtn = document.getElementById('submitBtn');

        function showError(message) {
            console.error('[UI] 오류 발생:', message);
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function hideError() { errorMessage.classList.add('hidden'); }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            const icon = type === 'success' 
                ? '<svg class="toast-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>'
                : '<svg class="toast-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>';
            toast.innerHTML = `${icon}<span>${message}</span>`;
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function showModal(title, message, onConfirm) {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.innerHTML = `
                <div class="modal">
                    <h3 class="modal-title">${title}</h3>
                    <p class="modal-content">${message}</p>
                    <div class="modal-actions">
                        <button class="btn btn-secondary" id="modalCancel">취소</button>
                        <button class="btn btn-danger" id="modalConfirm">삭제</button>
                    </div>
                </div>`;
            document.body.appendChild(overlay);
            overlay.querySelector('#modalCancel').onclick = () => overlay.remove();
            overlay.querySelector('#modalConfirm').onclick = () => { overlay.remove(); onConfirm(); };
            overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
        }

        function setButtonLoading(btn, loading) {
            if (loading) { btn.classList.add('btn-loading'); btn.disabled = true; }
            else { btn.classList.remove('btn-loading'); btn.disabled = false; }
        }

        async function fetchBoards(append = false) {
            if (isLoading) return;
            isLoading = true;
            if (!append) { boardsList.innerHTML = '<div class="loading"><div class="spinner"></div><p>게시글을 불러오는 중...</p></div>'; }

            console.log('[API] 게시글 목록을 불러옵니다.', { cursor, append });
            try {
                hideError();
                const url = cursor ? `${API_BASE}?last_id=${cursor}&size=${DEFAULT_SIZE}` : `${API_BASE}?size=${DEFAULT_SIZE}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('게시글을 불러오는데 실패했습니다');
                
                const result = await response.json();
                console.log('[API] 게시글 목록을 성공적으로 불러왔습니다:', result);
                cursor = result.pagination.next_cursor;
                hasMore = result.pagination.has_more;

                if (append) appendBoards(result.data);
                else renderBoards(result.data);
                updateLoadMoreButton();
            } catch (error) {
                console.error('[API] 게시글 목록 불러오기 실패:', error.message);
                showError(error.message);
                boardsList.innerHTML = '<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg><p>게시글을 불러오는데 실패했습니다</p></div>';
            } finally { isLoading = false; }
        }

        function renderBoards(boards) {
            if (boards.length === 0) {
                boardsList.innerHTML = '<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg><p>게시글이 없습니다. 첫 번째 글을 작성해보세요!</p></div>';
                return;
            }
            boardsList.innerHTML = boards.map(board => createBoardCard(board)).join('');
            addLoadMoreButton();
        }

        function appendBoards(boards) {
            const emptyState = boardsList.querySelector('.empty-state');
            if (emptyState) emptyState.remove();
            const loadMoreBtn = boardsList.querySelector('.load-more');
            if (loadMoreBtn) { loadMoreBtn.insertAdjacentHTML('beforebegin', boards.map(board => createBoardCard(board)).join('')); }
            else { boardsList.innerHTML += boards.map(board => createBoardCard(board)).join(''); }
        }

        function createBoardCard(board) {
            return `<div class="board-card" data-id="${board.id}">
                <div class="board-header">
                    <h3 class="board-title">${escapeHtml(board.title)}</h3>
                    <div class="board-actions">
                        <button class="btn btn-edit" onclick="editBoard(${board.id}, '${escapeHtml(board.title)}', '${escapeHtml(board.content).replace(/'/g, "\\'")}')">수정</button>
                        <button class="btn btn-danger" onclick="confirmDelete(${board.id})">삭제</button>
                    </div>
                </div>
                <div class="board-content">${escapeHtml(board.content)}</div>
                ${board.created_at ? `<div class="board-meta"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>작성일: ${new Date(board.created_at).toLocaleString()}</div>` : ''}
            </div>`;
        }

        function addLoadMoreButton() {
            const existing = boardsList.querySelector('.load-more');
            if (existing) existing.remove();
            if (hasMore) {
                const btn = document.createElement('div');
                btn.className = 'load-more';
                btn.innerHTML = `<button class="btn btn-primary" onclick="loadMore()">더 보기</button>`;
                boardsList.appendChild(btn);
            }
        }

        function updateLoadMoreButton() {
            const btn = boardsList.querySelector('.load-more .btn');
            if (btn) {
                if (isLoading) { btn.classList.add('btn-loading'); btn.disabled = true; }
                else { btn.classList.remove('btn-loading'); btn.disabled = false; btn.textContent = hasMore ? '더 보기' : '더 이상 게시물이 없습니다'; }
            }
        }

        function loadMore() { fetchBoards(true); }

        function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }

        createForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideError();
            const title = document.getElementById('title').value.trim();
            const content = document.getElementById('content').value.trim();
            if (!title) { showError('제목을 입력해주세요.'); return; }
            if (!content) { showError('내용을 입력해주세요.'); return; }

            console.log('[API] 새 게시글 작성을 시도합니다:', { title, content });
            setButtonLoading(submitBtn, true);

            try {
                const response = await fetch(API_BASE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, content })
                });

                if (!response.ok) { const error = await response.json(); throw new Error(error.message || '게시글 작성에 실패했습니다'); }
                console.log('[API] 게시글 작성을 성공했습니다.');
                createForm.reset();
                showToast('게시글이 작성되었습니다.');
                cursor = null;
                await fetchBoards();
            } catch (error) {
                console.error('[API] 게시글 작성 실패:', error.message);
                showError(error.message);
            } finally { setButtonLoading(submitBtn, false); }
        });

        function confirmDelete(id) { showModal('게시글 삭제', '정말로 이 게시글을 삭제하시겠습니까?', () => deleteBoard(id)); }

        async function deleteBoard(id) {
            hideError();
            console.log(`[API] 게시글 ID: ${id} 삭제를 시도합니다.`);
            const card = document.querySelector(`.board-card[data-id="${id}"]`);
            if (card) { card.style.opacity = '0.5'; card.style.pointerEvents = 'none'; }

            try {
                const response = await fetch(`${API_BASE}/${id}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('게시글 삭제에 실패했습니다');
                console.log(`[API] 게시글 ID: ${id} 삭제를 성공했습니다.`);
                showToast('게시글이 삭제되었습니다.');
                cursor = null;
                await fetchBoards();
            } catch (error) {
                console.error(`[API] 게시글 ID: ${id} 삭제 실패:`, error.message);
                showError(error.message);
                if (card) { card.style.opacity = '1'; card.style.pointerEvents = 'auto'; }
            }
        }

        function editBoard(id, title, content) {
            console.log(`[UI] 게시글 ID: ${id} 수정을 위한 폼을 엽니다.`);
            const card = document.querySelector(`.board-card[data-id="${id}"]`);
            const existingEditForm = card.querySelector('#editForm');
            if (existingEditForm) { existingEditForm.remove(); console.log('[UI] 기존 수정 폼을 닫습니다.'); return; }

            const editForm = document.createElement('div');
            editForm.id = 'editForm';
            editForm.innerHTML = `<h3 style="margin-bottom: 1rem; font-size: 1rem; font-weight: 600;">글 수정</h3>
                <form onsubmit="submitEdit(event, ${id})">
                    <div class="form-group"><label>제목</label><input type="text" id="editTitle" value="${escapeHtml(title)}" required maxlength="200"></div>
                    <div class="form-group"><label>내용</label><textarea id="editContent" required>${escapeHtml(content)}</textarea></div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="this.closest('#editForm').remove()">취소</button>
                        <button type="submit" class="btn btn-primary">저장</button>
                    </div>
                </form>`;
            card.appendChild(editForm);
        }

        async function submitEdit(event, id) {
            event.preventDefault();
            hideError();
            const title = document.getElementById('editTitle').value.trim();
            const content = document.getElementById('editContent').value.trim();
            if (!title || !content) { showError('제목과 내용을 모두 입력해주세요.'); return; }

            console.log(`[API] 게시글 ID: ${id} 수정을 시도합니다:`, { title, content });
            const editForm = document.querySelector(`#editForm`);
            const submitBtn = editForm.querySelector('button[type="submit"]');
            setButtonLoading(submitBtn, true);

            try {
                const response = await fetch(`${API_BASE}/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, content })
                });
                if (!response.ok) throw new Error('게시글 수정에 실패했습니다');
                console.log(`[API] 게시글 ID: ${id} 수정을 성공했습니다.`);
                showToast('게시글이 수정되었습니다.');
                await fetchBoards();
            } catch (error) {
                console.error(`[API] 게시글 ID: ${id} 수정 실패:`, error.message);
                showError(error.message);
            } finally { setButtonLoading(submitBtn, false); }
        }

        console.log('[UI] 애플리케이션을 초기화하고 게시글을 불러옵니다.');
        fetchBoards();
    </script>
</body>
</html>
